<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Automated HR Metric Analyzer – Secured</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 24px;
      background: radial-gradient(circle at top left, #e0f2ff 0, #f3f6ff 35%, #edf2f7 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
    }
    .card {
      background: rgba(255, 255, 255, 0.92);
      border-radius: 14px;
      padding: 18px 22px;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.15);
      max-width: 1200px;
      margin: 0 auto 22px auto;
      backdrop-filter: blur(12px);
      border: 1px solid rgba(148, 163, 184, 0.35);
    }
    #loginView.card {
      max-width: 700px;
      margin-top: 40px;
    }
    #requestView.card {
      max-width: 800px;
      margin-top: 40px;
      display: none;
    }
    h2 {
      margin-top: 0;
      color: #0f172a;
      letter-spacing: 0.02em;
      text-align: center;
    }
    h3 {
      margin-top: 0;
      color: #1e293b;
      text-align: center;
    }
    .form-row, .login-row {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: center;
      margin-bottom: 12px;
      justify-content: center;
    }
    .form-group {
      display: flex;
      flex-direction: column;
      font-size: 13px;
    }
    .form-group label {
      margin-bottom: 4px;
      font-weight: 600;
      color: #475569;
    }
    input[type="file"],
    input[type="date"],
    input[type="text"],
    input[type="password"],
    input[type="email"],
    textarea {
      padding: 7px 10px;
      font-size: 13px;
      border-radius: 6px;
      border: 1px solid #cbd5e1;
      background: #f8fafc;
      color: #0f172a;
      min-width: 220px;
    }
    input[type="file"] { background: #ffffff; }
    textarea { min-height: 70px; resize: vertical; }
    input:focus, textarea:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.15);
    }
    button, .btn-link {
      background: linear-gradient(135deg, #2563eb, #1d4ed8);
      color: #fff;
      border: none;
      border-radius: 999px;
      padding: 8px 18px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      margin-right: 8px;
      box-shadow: 0 6px 16px rgba(37, 99, 235, 0.35);
      transition: transform 0.08s ease, box-shadow 0.08s ease, opacity 0.08s ease;
      text-decoration: none;
      display: inline-block;
    }
    button:hover, .btn-link:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 20px rgba(37, 99, 235, 0.45);
      opacity: 0.95;
    }
    button.clear {
      background: linear-gradient(135deg, #ef4444, #b91c1c);
      box-shadow: 0 6px 16px rgba(239, 68, 68, 0.35);
    }
    #downloadLink {
      font-size: 13px;
      text-decoration: none;
      color: #1d4ed8;
      font-weight: 600;
    }
    #downloadLink:hover { text-decoration: underline; }

    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 10px;
      font-size: 11px;
      background: #ffffff;
    }
    th, td {
      border: 1px solid #e2e8f0;
      padding: 4px 6px;
      text-align: right;
      white-space: nowrap;
    }
    th {
      background: linear-gradient(135deg, #e5edff, #e0f2fe);
      text-align: center;
      font-weight: 600;
      color: #334155;
    }
    th.sticky-header { position: sticky; top: 0; z-index: 1; }
    td:first-child, th:first-child { text-align: left; }
    #tableWrapper, #typeTableWrapper {
      max-height: 380px;
      overflow: auto;
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      background: #f8fafc;
    }
    #log {
      font-size: 11px;
      color: #64748b;
      white-space: pre-wrap;
      margin-top: 6px;
    }
    .tab-buttons {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }
    .tab-btn {
      padding: 7px 16px;
      border-radius: 999px;
      border: 1px solid #cbd5e1;
      background: #f8fafc;
      cursor: pointer;
      font-size: 13px;
      color: #475569;
      font-weight: 500;
      box-shadow: none;
    }
    .tab-btn.active {
      background: linear-gradient(135deg, #2563eb, #1d4ed8);
      color: #fff;
      border-color: transparent;
      box-shadow: 0 4px 14px rgba(37, 99, 235, 0.35);
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit,minmax(180px,1fr));
      gap: 12px;
      margin-top: 10px;
    }
    .kpi-card {
      border-radius: 12px;
      padding: 12px 14px;
      background: linear-gradient(135deg, #4f46e5, #0ea5e9);
      color: #f9fafb;
      box-shadow: 0 10px 24px rgba(15, 23, 42, 0.35);
    }
    .kpi-value { font-size: 20px; font-weight: 700; margin-bottom: 4px; }
    .kpi-label { font-size: 11px; opacity: 0.9; }

    #appView { display: none; }

    .login-note {
      font-size: 12px;
      color: #64748b;
      margin-top: 6px;
      text-align: center;
    }

    /* header with logout */
    .top-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    .logout-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      font-size: 12px;
      background: linear-gradient(135deg, #f97316, #ea580c);
      box-shadow: 0 6px 16px rgba(234, 88, 12, 0.35);
    }
  </style>
</head>
<body>

  <!-- LOGIN SCREEN -->
  <div class="card" id="loginView">
    <h2>Automated HR Metric Analyzer – Login</h2>

    <div style="display:flex;flex-direction:column;align-items:center;gap:10px;">
      <div class="form-group" style="width:260px;">
        <label for="loginUser">User ID</label>
        <input type="text" id="loginUser" autocomplete="off" style="width:100%;">
      </div>
      <div class="form-group" style="width:260px;">
        <label for="loginPass">Password</label>
        <input type="password" id="loginPass" autocomplete="off" style="width:100%;">
      </div>
      <div style="margin-top:8px;display:flex;gap:10px;justify-content:center;">
        <button onclick="handleLogin()">Login</button>
        <button onclick="openRequestPage()">Request New Credentials</button>
      </div>
    </div>

    <div id="loginMessage" style="font-size:12px;color:#64748b;margin-top:8px;text-align:center;">
      Enter your credentials, or click “Request New Credentials” to raise a request.
    </div>
  </div>

  <!-- REQUEST NEW CREDENTIALS PAGE -->
  <div class="card" id="requestView">
    <h2>Request New Login Credentials</h2>
    <div class="login-row">
      <div class="form-group">
        <label for="reqEmpId">Employee ID</label>
        <input type="text" id="reqEmpId" placeholder="Employee ID">
      </div>
      <div class="form-group">
        <label for="reqEmpName">Employee Name</label>
        <input type="text" id="reqEmpName" placeholder="Employee name">
      </div>
      <div class="form-group">
        <label for="reqDate">Request Date</label>
        <input type="date" id="reqDate">
      </div>
    </div>

    <div class="login-row">
      <div class="form-group">
        <label for="reqDept">Department</label>
        <input type="text" id="reqDept" placeholder="Department">
      </div>
      <div class="form-group">
        <label for="reqEmail">Email ID</label>
        <input type="email" id="reqEmail" placeholder="Official email ID">
      </div>
      <div class="form-group">
        <label for="reqUserId">Requested User ID</label>
        <input type="text" id="reqUserId" placeholder="Preferred login ID">
      </div>
    </div>

    <div class="login-row">
      <div class="form-group" style="flex:1;min-width:300px;">
        <label for="reqDesc">Description / Justification</label>
        <textarea id="reqDesc" placeholder="Brief reason for access request"></textarea>
      </div>
    </div>

    <div style="text-align:center;margin-top:10px;">
      <button onclick="submitRequest()">Submit Request</button>
      <button class="clear" onclick="backToLogin()">Back to Login</button>
    </div>

    <div id="reqMessage" style="font-size:12px;color:#b91c1c;margin-top:6px;text-align:center;"></div>

    <div class="login-note">
      On submit, your email application will open with all details pre‑filled in a mail to the project owner.
    </div>
  </div>

  <!-- MAIN APP (HIDDEN UNTIL LOGIN) -->
  <div id="appView">
    <div class="card" id="topCard">
      <div class="top-header">
        <h2 style="margin-bottom:0;">Automated HR Metric Analyzer</h2>
        <button class="logout-btn" onclick="handleLogout()" title="Logout">
          <span>⎋</span><span>Logout</span>
        </button>
      </div>

      <div class="form-row" style="margin-top:12px;">
        <div class="form-group">
          <label for="fileInput">Upload File</label>
          <input type="file" id="fileInput" accept=".xlsx,.xls">
        </div>
        <div class="form-group">
          <label for="fromDate">From date</label>
          <input type="date" id="fromDate">
        </div>
        <div class="form-group">
          <label for="toDate">To date</label>
          <input type="date" id="toDate">
        </div>
        <div class="form-group" style="margin-top:18px;">
          <button onclick="processFile()">Generate Summary</button>
          <button class="clear" onclick="clearData()">Clear</button>
        </div>
        <div class="form-group" style="margin-top:22px;">
          <a id="downloadLink" style="display:none;">Download Summary (Excel)</a>
        </div>
        <div class="form-group" style="margin-top:18px;">
          <button onclick="downloadSample()">Download Sample File</button>
        </div>
      </div>
      <div id="log"></div>
    </div>

    <div class="card" id="kpiCard" style="display:none;">
      <h3>Period KPIs (Selected Dates)</h3>
      <div class="kpi-grid" id="kpiGrid"></div>
    </div>

    <div class="card">
      <div class="tab-buttons">
        <button class="tab-btn active" data-tab="headcount">Headcount Summary</button>
        <button class="tab-btn" data-tab="type">Employee Type</button>
      </div>

      <div id="headcount-tab" class="tab-content active">
        <div class="form-row" style="margin-bottom:8px;justify-content:flex-start;">
          <button style="padding:6px 12px; box-shadow:none;">Headcount Summary</button>
          <input type="text" id="headcountSummary" style="margin-left:10px;width:140px;" readonly value="0">
        </div>
        <h3>Summary – Detail View</h3>
        <div id="tableWrapper">
          <div id="tableContainer" style="font-size:12px;color:#777;">
            No data yet. Upload master-dump.xlsx and generate.
          </div>
        </div>
      </div>

      <div id="type-tab" class="tab-content">
        <h3>Employee Type – Closing HC</h3>
        <div id="typeTableWrapper">
          <div id="typeTableContainer" style="font-size:12px;color:#777;">
            No data yet. Upload master-dump.xlsx and generate.
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="xlsx.full.min.js"></script>

  <script>
    /* ====== LOGIN USERS ====== */
    const USERS = [
      { user: "PADMA", pass: "PADMA@TATA" },
      { user: "SUHAS", pass: "SUHAS@123" },
      { user: "JOTHIKA", pass: "JOTHIKA@123" }
    ];

    function handleLogin() {
      const u = document.getElementById('loginUser').value.trim();
      const p = document.getElementById('loginPass').value;
      const msg = document.getElementById('loginMessage');

      if (!u || !p) {
        msg.textContent = "Please enter both User ID and Password.";
        return;
      }
      const ok = USERS.some(x => x.user === u && x.pass === p);
      if (ok) {
        msg.textContent = "";
        document.getElementById('loginView').style.display = "none";
        document.getElementById('requestView').style.display = "none";
        document.getElementById('appView').style.display = "block";
      } else {
        msg.textContent = "Invalid User ID or Password. Please try again.";
      }
    }

    function handleLogout() {
      clearData();
      document.getElementById('appView').style.display = "none";
      document.getElementById('requestView').style.display = "none";
      document.getElementById('loginUser').value = "";
      document.getElementById('loginPass').value = "";
      document.getElementById('loginMessage').textContent =
        "Enter your credentials, or click “Request New Credentials” to raise a request.";
      document.getElementById('loginView').style.display = "block";
      window.scrollTo(0, 0);
    }

    function openRequestPage() {
      document.getElementById('loginView').style.display = "none";
      document.getElementById('requestView').style.display = "block";
    }

    function backToLogin() {
      document.getElementById('requestView').style.display = "none";
      document.getElementById('loginView').style.display = "block";
    }

    function submitRequest() {
      const empId  = document.getElementById('reqEmpId').value.trim();
      const empName = document.getElementById('reqEmpName').value.trim();
      const reqDate = document.getElementById('reqDate').value;
      const dept   = document.getElementById('reqDept').value.trim();
      const email  = document.getElementById('reqEmail').value.trim();
      const userId = document.getElementById('reqUserId').value.trim();
      const desc   = document.getElementById('reqDesc').value.trim();
      const msg    = document.getElementById('reqMessage');

      if (!empId || !empName || !reqDate || !dept || !email || !userId || !desc) {
        msg.textContent = "Please fill all fields before submitting.";
        return;
      }
      msg.textContent = "";

      const to = "padmaloshini.s-ext@tataelectronics.co.in";
      const subject = encodeURIComponent("New credentials request – Automated HR Metric Analyzer");
      const bodyLines = [
        "Dear Padmaloshini S,",
        "",
        "Please create login credentials for the Automated HR Metric Analyzer tool.",
        "",
        "Request Details:",
        "Employee ID: " + empId,
        "Employee Name: " + empName,
        "Request Date: " + reqDate,
        "Department: " + dept,
        "Email ID: " + email,
        "Requested User ID: " + userId,
        "",
        "Description / Justification:",
        desc,
        "",
        "Regards,"
      ];
      const body = encodeURIComponent(bodyLines.join("\n"));
      const mailtoLink = "mailto:" + to + "?subject=" + subject + "&body=" + body;
      window.location.href = mailtoLink;
    }

    /* ====== ANALYZER LOGIC ====== */

    let globalSummary = null;
    let globalTypeSummary = null;

    document.addEventListener('DOMContentLoaded', () => {
      const buttons = document.querySelectorAll('.tab-btn');
      buttons.forEach(btn => {
        btn.addEventListener('click', function () {
          const tab = this.getAttribute('data-tab');
          buttons.forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          document.getElementById(tab + '-tab').classList.add('active');
        });
      });
    });

    function log(msg) { document.getElementById('log').textContent = msg; }

    function notify(msg) {
      log(msg);
      const card = document.getElementById('topCard');
      const oldBorder = card.style.border;
      card.style.border = '1px solid #ef4444';
      setTimeout(() => { card.style.border = oldBorder; }, 1500);
    }

    function dateOnly(d) { return new Date(d.getFullYear(), d.getMonth(), d.getDate()); }
    function addDays(d, n) { const r = new Date(d); r.setDate(r.getDate() + n); return r; }

    function parseDateCell(val) {
      if (val == null || val === "") return null;
      if (val instanceof Date) return dateOnly(val);
      if (typeof val === "number") {
        const excelEpoch = new Date(Date.UTC(1899, 11, 30));
        const ms = val * 24 * 60 * 60 * 1000;
        return dateOnly(new Date(excelEpoch.getTime() + ms));
      }
      const s = String(val).trim();
      if (!s) return null;
      const d = new Date(s);
      if (isNaN(d.getTime())) return null;
      return dateOnly(d);
    }

    function formatLocalDate(d) {
      return [
        d.getFullYear(),
        String(d.getMonth() + 1).padStart(2, "0"),
        String(d.getDate()).padStart(2, "0")
      ].join("-");
    }

    function renderTable(containerId, summary, headers) {
      const cont = document.getElementById(containerId);
      cont.innerHTML = "";
      if (!summary || !summary.length) {
        cont.textContent = "No data for selected period.";
        return;
      }
      const table = document.createElement('table');
      const thead = document.createElement('thead');
      const tbody = document.createElement('tbody');

      const trh = document.createElement('tr');
      headers.forEach(h => {
        const th = document.createElement('th');
        th.textContent = h;
        th.classList.add('sticky-header');
        trh.appendChild(th);
      });
      thead.appendChild(trh);

      summary.forEach(row => {
        const tr = document.createElement('tr');
        headers.forEach(h => {
          const td = document.createElement('td');
          td.textContent = row[h];
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });

      table.appendChild(thead);
      table.appendChild(tbody);
      cont.appendChild(table);
    }

    function renderKPIs(summary) {
      const kpiCard = document.getElementById('kpiCard');
      const grid = document.getElementById('kpiGrid');
      grid.innerHTML = "";
      if (!summary || !summary.length) {
        kpiCard.style.display = 'none';
        return;
      }

      const totals = summary.reduce((acc, d) => {
        acc.joiners += +d["New Joiners"] || 0;
        acc.attr    += +d["Attrition HC"] || 0;
        acc.infant  += +d["Infant Attrition HC"] || 0;
        acc.avgAcc  += (+d["Opening HC"] || 0) + (+d["Closing HC"] || 0);
        return acc;
      }, { joiners:0, attr:0, infant:0, avgAcc:0 });

      const days      = summary.length;
      const openingHC = summary[0]["Opening HC"];
      const closingHC = summary[summary.length-1]["Closing HC"];
      const avgHC     = totals.avgAcc / (2 * days);

      let attrPct = 0;
      if (avgHC > 0) { attrPct = (totals.attr / avgHC) * 100; }

      let infantPct = 0;
      if (totals.joiners > 0) { infantPct = (totals.infant / totals.joiners) * 100; }

      const kpis = [
        { label: "Total Days", value: days },
        { label: "Avg Headcount", value: isNaN(avgHC) ? 0 : avgHC.toFixed(0) },
        { label: "Opening HC (Period)", value: openingHC },
        { label: "Closing HC (Period)", value: closingHC },
        { label: "Total Joiners", value: totals.joiners },
        { label: "Total Attrition HC", value: totals.attr },
        { label: "Attrition %", value: attrPct.toFixed(2) + "%" },
        { label: "Infant Attrition HC", value: totals.infant },
        { label: "Infant %", value: infantPct.toFixed(2) + "%" }
      ];

      kpis.forEach(k => {
        const card = document.createElement('div');
        card.className = "kpi-card";
        card.innerHTML =
          `<div class="kpi-value">${k.value}</div><div class="kpi-label">${k.label}</div>`;
        grid.appendChild(card);
      });

      kpiCard.style.display = 'block';
    }

    function clearData() {
      globalSummary = null;
      globalTypeSummary = null;
      document.getElementById('tableContainer').textContent =
        "No data yet. Upload master-dump.xlsx and generate.";
      document.getElementById('typeTableContainer').textContent =
        "No data yet. Upload master-dump.xlsx and generate.";
      document.getElementById('downloadLink').style.display = "none";
      document.getElementById('kpiCard').style.display = "none";
      const fileInput = document.getElementById('fileInput');
      if (fileInput) fileInput.value = "";
      const hc = document.getElementById('headcountSummary');
      if (hc) hc.value = 0;
      log("Cleared.");
    }

    function downloadSample() {
      const sampleRows = [
        {
          "Employee ID":"E001",
          "Employee Name":"Sample Name 1",
          "Gender":"Female",
          "Date of Joining":"2025-12-01",
          "Exit Date":"",
          "Status":"Active",
          "Business Unit":"DL-Jasmine",
          "Department":"Production",
          "Location":"Hosur",
          "Employment Type":"ODL",
          "Designation":"Operator"
        },
        {
          "Employee ID":"E002",
          "Employee Name":"Sample Name 2",
          "Gender":"Male",
          "Date of Joining":"2025-12-02",
          "Exit Date":"2025-12-10",
          "Status":"Left",
          "Business Unit":"DL-Jasmine",
          "Department":"Production",
          "Location":"Hosur",
          "Employment Type":"CDL",
          "Designation":"Operator"
        }
      ];
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.json_to_sheet(sampleRows);
      XLSX.utils.book_append_sheet(wb, ws, "master dump");
      XLSX.writeFile(wb, "sample_master_dump.xlsx");
    }

    function processFile() {
      const fileInput   = document.getElementById('fileInput');
      const fromDateStr = document.getElementById('fromDate').value;
      const toDateStr   = document.getElementById('toDate').value;

      document.getElementById('tableContainer').innerHTML     = "Processing...";
      document.getElementById('typeTableContainer').innerHTML = "Processing...";
      document.getElementById('downloadLink').style.display   = "none";
      document.getElementById('headcountSummary').value       = 0;
      log("");

      if (!fileInput.files.length) {
        notify("Please choose the input file before clicking Generate Summary.");
        document.getElementById('tableContainer').innerHTML =
          "No data yet. Upload master-dump.xlsx and generate.";
        document.getElementById('typeTableContainer').innerHTML =
          "No data yet. Upload master-dump.xlsx and generate.";
        return;
      }
      if (!fromDateStr || !toDateStr) {
        notify("Please select both From date and To date.");
        document.getElementById('tableContainer').innerHTML =
          "No data yet. Upload master-dump.xlsx and generate.";
        document.getElementById('typeTableContainer').innerHTML =
          "No data yet. Upload master-dump.xlsx and generate.";
        return;
      }

      const fromDate = dateOnly(new Date(fromDateStr));
      const toDate   = dateOnly(new Date(toDateStr));
      const file     = fileInput.files[0];

      const reader = new FileReader();
      reader.onload = function (e) {
        try {
          const data      = new Uint8Array(e.target.result);
          const workbook  = XLSX.read(data, { type: 'array' });
          const sheetName = workbook.SheetNames[0];
          const sheet     = workbook.Sheets[sheetName];
          const rows      = XLSX.utils.sheet_to_json(sheet, { raw: true });

          rows.forEach(r => {
            r.DOJ        = parseDateCell(r["Date of Joining"]);
            r.Exit       = parseDateCell(r["Exit Date"]);
            r.GenderNorm = (r["Gender"] || "").toString().toLowerCase();
            r.EmpType    = (r["Employment Type"] || "").toString().trim();
          });

          const summary = [];
          const typeMap = {};

          const prevDay = addDays(fromDate, -1);
          let prevClosingHC = rows.filter(r => {
            if (!r.DOJ) return false;
            if (r.DOJ > prevDay) return false;
            if (!r.Exit) return true;
            return r.Exit > prevDay;
          }).length;

          for (let d = fromDate; d <= toDate; d = addDays(d, 1)) {
            const day     = dateOnly(d);
            const dateStr = formatLocalDate(day);

            const joiners = rows.filter(r => r.DOJ && r.DOJ.getTime() === day.getTime());
            const joinF   = joiners.filter(r => r.GenderNorm === "female");
            const joinM   = joiners.filter(r => r.GenderNorm === "male");

            const leavers = rows.filter(r => r.Exit && r.Exit.getTime() === day.getTime());
            const leaveF  = leavers.filter(r => r.GenderNorm === "female");
            const leaveM  = leavers.filter(r => r.GenderNorm === "male");

            const openingHC = prevClosingHC;

            const closingEmployees = rows.filter(r => {
              if (!r.DOJ) return false;
              if (r.DOJ > day) return false;
              if (!r.Exit) return true;
              return r.Exit > day;
            });

            const closingHC = closingEmployees.length;
            const closingF  = closingEmployees.filter(r => r.GenderNorm === "female").length;
            const closingM  = closingEmployees.filter(r => r.GenderNorm === "male").length;

            const infant = leavers.filter(r => {
              if (!r.DOJ || !r.Exit) return false;
              const diffDays = (r.Exit - r.DOJ) / (1000 * 60 * 60 * 24);
              return diffDays <= 30;
            });
            const infantHC = infant.length;

            const attrHC  = leavers.length;
            const attrHCF = leaveF.length;
            const attrHCM = leaveM.length;

            const avgHC = (openingHC + closingHC) / 2;
            let attrPct = 0;
            if (avgHC > 0) { attrPct = (attrHC / avgHC) * 100; }

            summary.push({
              "Date": dateStr,
              "Opening HC": openingHC,
              "Closing HC": closingHC,
              "Closing HC Female": closingF,
              "Closing HC Male": closingM,
              "New Joiners": joiners.length,
              "New Joiners Female": joinF.length,
              "New Joiners Male": joinM.length,
              "Attrition HC": attrHC,
              "Attrition HC Female": attrHCF,
              "Attrition HC Male": attrHCM,
              "Attrition %": attrPct.toFixed(2),
              "Infant Attrition HC": infantHC
            });

            prevClosingHC = closingHC;

            const typeCounts = {};
            closingEmployees.forEach(r => {
              const t = r.EmpType || "Unknown";
              typeCounts[t] = (typeCounts[t] || 0) + 1;
            });
            typeMap[dateStr] = typeCounts;
          }

          const typeRows = [];
          Object.entries(typeMap).forEach(([date, counts]) => {
            Object.entries(counts).forEach(([type, cnt]) => {
              typeRows.push({
                "Date": date,
                "Employment Type": type,
                "Closing HC": cnt
              });
            });
          });

          globalSummary     = summary;
          globalTypeSummary = typeRows;

          const headHeaders = [
            "Date","Opening HC","Closing HC","Closing HC Female","Closing HC Male",
            "New Joiners","New Joiners Female","New Joiners Male",
            "Attrition HC","Attrition HC Female","Attrition HC Male",
            "Attrition %","Infant Attrition HC"
          ];
          renderTable("tableContainer", summary, headHeaders);

          const typeHeaders = ["Date","Employment Type","Closing HC"];
          renderTable("typeTableContainer", typeRows, typeHeaders);

          renderKPIs(summary);

          if (summary.length > 0) {
            const lastDay = summary[summary.length - 1];
            document.getElementById('headcountSummary').value = lastDay["Closing HC"];
          }

          const wb   = XLSX.utils.book_new();
          const ws1  = XLSX.utils.json_to_sheet(summary);
          XLSX.utils.book_append_sheet(wb, ws1, "Daily Summary");
          const ws2  = XLSX.utils.json_to_sheet(typeRows);
          XLSX.utils.book_append_sheet(wb, ws2, "Employee Type");
          const wbout = XLSX.write(wb, { bookType:'xlsx', type:'array' });
          const blob  = new Blob([wbout], { type:'application/octet-stream' });
          const url   = URL.createObjectURL(blob);
          const link  = document.getElementById('downloadLink');
          link.href        = url;
          link.download    = 'daily_headcount_summary_from_master.xlsx';
          link.style.display = "inline";

          log("Summary days: " + summary.length + " | Type rows: " + typeRows.length);
        } catch (err) {
          log("Error: " + err.message);
          document.getElementById('tableContainer').textContent     = "Error processing file.";
          document.getElementById('typeTableContainer').textContent = "Error processing file.";
          document.getElementById('headcountSummary').value = 0;
        }
      };

      reader.readAsArrayBuffer(file);
    }
  </script>
</body>
</html>


